---
import Layout from '../../../layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { drizzle } from 'drizzle-orm/d1';
import * as schema from '../../../../backend/db/schema';
import { eq } from 'drizzle-orm';
import { PlateDocumentEditor } from '../../../components/resume/PlateDocumentEditor';

const { id } = Astro.params;
const runtime = Astro.locals.runtime;
if (!runtime) throw new Error("Missing Cloudflare runtime");

const db = drizzle(runtime.env.DB, { schema });
const jobId = parseInt(id as string, 10);

const job = await db.query.jobs.findFirst({
  where: eq(schema.jobs.id, jobId),
  with: {
    company: true,
    applicationMaterials: true
  }
});

if (!job) return new Response("Job not found", { status: 404 });

const resume = job.applicationMaterials.find(m => m.type === 'resume');
const coverLetter = job.applicationMaterials.find(m => m.type === 'cover_letter');

// Mock content if Agents haven't run yet
const defaultContent = [{ type: 'p', children: [{ text: 'Content is being generated by WriterAgent...' }]}];
---

<Layout title={`Materials: ${job.title} | Head Hunter`}>
  <main class="container mx-auto py-10 px-6 lg:px-8">
    <div class="flex justify-between items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-white mb-2">Application Materials</h1>
        <p class="text-muted-foreground text-lg">{job.company?.name} • {job.title}</p>
      </div>
      <div class="flex gap-2">
        <Button variant="outline" asChild><a href={`/jobs/${job.id}`}>← Back to Review</a></Button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* Resume Editor */}
      <Card class="flex flex-col h-[700px]">
        <CardHeader>
          <CardTitle>Generated Resume</CardTitle>
          <CardDescription>Tailored to match profile vs description</CardDescription>
        </CardHeader>
        <CardContent class="flex-1 overflow-hidden">
          {resume ? (
             <PlateDocumentEditor 
                client:load 
                documentId={resume.id} 
                initialContent={resume.content as any[] || defaultContent} 
                onSave={async (content) => {
                  await fetch(`/api/materials/${resume.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                  });
                }}
             />
          ) : (
            <div class="h-full flex items-center justify-center border-2 border-dashed border-border rounded-lg p-6 bg-muted/10">
              <div class="text-center">
                <p class="text-muted-foreground mb-4">No resume generated yet.</p>
                <Button>Trigger WriterAgent</Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Cover Letter Editor */}
      <Card class="flex flex-col h-[700px]">
        <CardHeader>
          <CardTitle>Cover Letter</CardTitle>
          <CardDescription>Narrative explanation of fit</CardDescription>
        </CardHeader>
        <CardContent class="flex-1 overflow-hidden">
          {coverLetter ? (
             <PlateDocumentEditor 
                client:load 
                documentId={coverLetter.id} 
                initialContent={coverLetter.content as any[] || defaultContent}
                onSave={async (content) => {
                  await fetch(`/api/materials/${coverLetter.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                  });
                }}
             />
          ) : (
            <div class="h-full flex items-center justify-center border-2 border-dashed border-border rounded-lg p-6 bg-muted/10">
              <div class="text-center">
                <p class="text-muted-foreground mb-4">No cover letter generated yet.</p>
                <Button>Trigger WriterAgent</Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  </main>
</Layout>
